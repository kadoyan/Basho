# アーキテクチャドキュメント

## プロジェクト構造

```
Location-Logger2/
├── src/
│   ├── components/          # 再利用可能なVueコンポーネント
│   │   ├── RecordItem.vue           # 記録リストアイテム
│   │   └── RecordDetailModal.vue    # 記録詳細モーダル
│   │
│   ├── views/              # ページレベルのコンポーネント
│   │   ├── LoginView.vue            # ログイン画面
│   │   └── MainView.vue             # メイン画面
│   │
│   ├── stores/             # Pinia状態管理
│   │   ├── auth.js                  # 認証状態
│   │   └── location.js              # 位置情報記録状態
│   │
│   ├── services/           # ビジネスロジック
│   │   ├── crypto.js                # AES-GCM暗号化
│   │   ├── indexeddb.js             # ローカルストレージ
│   │   └── dynamodb.js              # クラウドストレージ
│   │
│   ├── config/             # 設定ファイル
│   │   └── aws-config.example.js    # AWS設定例
│   │
│   ├── App.vue             # ルートコンポーネント
│   ├── main.js             # エントリーポイント
│   └── style.css           # グローバルスタイル
│
├── lambda/                 # AWS Lambda関数
│   ├── index.js                     # Lambda関数本体
│   ├── package.json                 # Lambda依存関係
│   └── README.md                    # デプロイガイド
│
├── index.html              # HTMLテンプレート
├── package.json            # プロジェクト依存関係
├── vite.config.js          # Vite設定
├── tailwind.config.js      # Tailwind CSS設定
├── postcss.config.js       # PostCSS設定
├── amplify.yml             # Amplify Hosting設定
└── README.md               # プロジェクト説明
```

## データフロー

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │
       │ ボタンクリック
       ▼
┌─────────────────────────────────┐
│    MainView.vue (UI)            │
└──────┬──────────────────────────┘
       │
       │ recordLocation()
       ▼
┌─────────────────────────────────┐
│  locationStore (Pinia)          │
│  - 位置情報取得                   │
│  - 暗号化                        │
│  - 保存制御                      │
└──────┬──────────────────────────┘
       │
       ├─────────────────┬──────────────────┐
       │                 │                  │
       ▼                 ▼                  ▼
┌─────────────┐  ┌──────────────┐  ┌──────────────┐
│ crypto.js   │  │indexeddb.js  │  │dynamodb.js   │
│ (暗号化)     │  │(ローカル保存) │  │(クラウド保存) │
└─────────────┘  └──────────────┘  └──────┬───────┘
                                          │
                                          │ API呼び出し
                                          ▼
                                  ┌──────────────┐
                                  │API Gateway   │
                                  └──────┬───────┘
                                         │
                                         ▼
                                  ┌──────────────┐
                                  │AWS Lambda    │
                                  └──────┬───────┘
                                         │
                                         ▼
                                  ┌──────────────┐
                                  │DynamoDB      │
                                  └──────────────┘
```

## セキュリティアーキテクチャ

### クライアントサイド暗号化

```
┌────────────────────────────────────────────────────┐
│                  ユーザーのブラウザ                   │
│                                                    │
│  ┌──────────────────────────────────────────┐    │
│  │ 1. 暗号化キーの生成・保存                   │    │
│  │    - AES-GCM 256bit                      │    │
│  │    - IndexedDB (KeysDB) に保存           │    │
│  └──────────────────────────────────────────┘    │
│                      ↓                            │
│  ┌──────────────────────────────────────────┐    │
│  │ 2. 位置情報の暗号化                        │    │
│  │    - 平文データをJSON化                    │    │
│  │    - AES-GCMで暗号化                      │    │
│  │    - ランダムIV (12バイト)                 │    │
│  └──────────────────────────────────────────┘    │
│                      ↓                            │
│  ┌──────────────────────────────────────────┐    │
│  │ 3. ローカル保存                            │    │
│  │    - IndexedDB (RecordsDB)               │    │
│  │    - 暗号化されたデータのみ                 │    │
│  └──────────────────────────────────────────┘    │
│                      ↓                            │
│  ┌──────────────────────────────────────────┐    │
│  │ 4. クラウド同期                            │    │
│  │    - 暗号化されたデータを送信               │    │
│  │    - 復号化キーは送信しない                 │    │
│  └──────────────────────────────────────────┘    │
└────────────────────────────────────────────────────┘
                       ↓
┌────────────────────────────────────────────────────┐
│                  AWSクラウド                        │
│                                                    │
│  ┌──────────────────────────────────────────┐    │
│  │ DynamoDB                                 │    │
│  │ - 暗号化されたデータのみ保存                │    │
│  │ - 復号化不可能（キーがない）                │    │
│  └──────────────────────────────────────────┘    │
└────────────────────────────────────────────────────┘
```

### 暗号化の特徴

1. **エンドツーエンド暗号化**: データは常に暗号化された状態
2. **クライアントサイドキー管理**: 暗号化キーはブラウザ内のみ
3. **ゼロ知識証明**: サーバー側（AWS）でもデータを復号化できない
4. **デバイス固有**: 各ブラウザで独立した暗号化キー

### データ構造

#### 暗号化前（クライアント内のみ）
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": 1234567890000,
  "latitude": 35.6762,
  "longitude": 139.6503,
  "accuracy": 10.5,
  "heading": 270,
  "comment": "東京タワー付近",
  "createdAt": "2024-01-01T12:00:00.000Z"
}
```

#### 暗号化後（保存・送信）
```json
{
  "data": "base64EncodedEncryptedData...",
  "encrypted": true
}
```

## 認証フロー

```
1. ユーザー登録
   ↓
   [ブラウザ] → signUp() → [Cognito]
   ↓
   確認コード送信（メール）
   ↓
   確認完了

2. ログイン
   ↓
   [ブラウザ] → signIn() → [Cognito]
   ↓
   IDトークン発行
   ↓
   トークンをメモリに保存

3. API呼び出し
   ↓
   [ブラウザ] → Authorization: Bearer <token> → [API Gateway]
   ↓
   [API Gateway] → Cognito Authorizerで検証 → [Lambda]
   ↓
   userIdを取得してDB操作
```

## 状態管理（Pinia）

### authStore
- `isAuthenticated`: ログイン状態
- `user`: ユーザー情報
- `login()`: ログイン処理
- `signup()`: 新規登録
- `logout()`: ログアウト
- `getIdToken()`: APIトークン取得

### locationStore
- `records`: 記録一覧（復号化済み）
- `recordLocation()`: 位置情報を記録
- `loadRecords()`: 記録を読み込み
- `updateComment()`: コメント更新
- `deleteRecord()`: 記録削除
- `syncWithCloud()`: クラウド同期

## デプロイ戦略

### オプション1: AWS Amplify Hosting（推奨）
- **メリット**: CI/CD自動化、SSL自動設定、簡単なセットアップ
- **コスト**: 月額 $0〜15程度（トラフィック次第）
- **手順**: GitHubリポジトリ連携 → 自動デプロイ

### オプション2: S3 + CloudFront
- **メリット**: 最安コスト、完全制御
- **コスト**: 月額 $1〜5程度
- **手順**: S3にビルド成果物アップロード → CloudFront配信

## パフォーマンス最適化

1. **遅延読み込み**: コンポーネントの動的インポート
2. **IndexedDB**: 大量データの高速アクセス
3. **暗号化**: Web Crypto APIでネイティブ速度
4. **キャッシング**: 暗号化キーの再利用

## スケーラビリティ

- **DynamoDB**: オートスケーリング対応
- **Lambda**: 自動スケール
- **CloudFront**: グローバルCDN
- **クライアントサイド処理**: サーバー負荷最小化

## 今後の拡張案

1. **オフライン対応強化**: Service Workerによるキャッシング
2. **位置情報の自動記録**: バックグラウンド追跡
3. **複数デバイス同期**: リアルタイム同期
4. **データエクスポート**: CSV/GPX形式でエクスポート
5. **地図表示**: 記録の軌跡を地図上に表示
6. **共有機能**: 選択した記録を他のユーザーと共有
